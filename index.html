<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <!-- author Leo Baschy 2021 initially -->
  <title>Inflation — US — Annual</title>
  <style>
    .container {
      display: grid;
      grid-template-columns: min-content 3fr min-content 3fr;
      gap: 1rem;
      width: min-content;
    }

    .heading {
      grid-column: 1 / 5;
      font-family: sans-serif;
      font-size: larger;
    }

    .container * {
      align-self: baseline;
    }

    input[type='number'] {
      max-width: 10em;
    }

    .memorize {
      grid-column: 1 / 3;
      display: none;
    }

    .copy {
      grid-column: 3 / 5;
    }

    .explanation {
      grid-column: 1 / 5;
      font-size: smaller;
    }
  </style>
</head>

<body>
  <div id="calculator">
    <div class="container">
      <div class="heading">Inflation — US</div>
      <div></div>
      <div>Year</div>
      <div></div>
      <div>Amount</div>
      <div>
        From:
      </div>
      <div>
        <select name="fromYear">
        </select>
      </div>
      <div>
        $
      </div>
      <div>
        <input name="fromAmount" type="number" min="0" />
      </div>
      <div class="col-md-2">
        To:
      </div>
      <div>
        <select name="toYear">
        </select>
      </div>
      <div>
        $
      </div>
      <div>
        <input name="toAmount" type="number" min="0" />
      </div>
      <div class="explanation">For the current amounts:</div>
      <div class="memorize">
        <button><label>Memorize</label></button>
      </div>
      <div class="copy">
        <button onclick="copyURL()"><label>Copy URL to Share</label></button>
      </div>
    </div>
  </div>
  <script>
    // data from https://www.bls.gov/data/inflation_calculator.htm
    const cpi = {
      "1913": 100,
      "1914": 102,
      "1915": 103,
      "1916": 106,
      "1917": 119,
      "1918": 143,
      "1919": 168,
      "1920": 200,
      "1921": 194,
      "1922": 172,
      "1923": 171,
      "1924": 177,
      "1925": 177,
      "1926": 183,
      "1927": 179,
      "1928": 177,
      "1929": 174,
      "1930": 174,
      "1931": 162,
      "1932": 146,
      "1933": 132,
      "1934": 135,
      "1935": 139,
      "1936": 141,
      "1937": 144,
      "1938": 145,
      "1939": 143,
      "1940": 142,
      "1941": 144,
      "1942": 160,
      "1943": 172,
      "1944": 178,
      "1945": 182,
      "1946": 186,
      "1947": 219,
      "1948": 242,
      "1949": 245,
      "1950": 240,
      "1951": 259,
      "1952": 270,
      "1953": 271,
      "1954": 274,
      "1955": 272,
      "1956": 273,
      "1957": 282,
      "1958": 292,
      "1959": 296,
      "1960": 299,
      "1961": 304,
      "1962": 306,
      "1963": 310,
      "1964": 315,
      "1965": 318,
      "1966": 324,
      "1967": 336,
      "1968": 348,
      "1969": 363,
      "1970": 386,
      "1971": 406,
      "1972": 419,
      "1973": 435,
      "1974": 476,
      "1975": 532,
      "1976": 567,
      "1977": 597,
      "1978": 638,
      "1979": 697,
      "1980": 794,
      "1981": 888,
      "1982": 962,
      "1983": 998,
      "1984": 1040,
      "1985": 1077,
      "1986": 1118,
      "1987": 1135,
      "1988": 1181,
      "1989": 1236,
      "1990": 1300,
      "1991": 1373,
      "1992": 1409,
      "1993": 1455,
      "1994": 1492,
      "1995": 1534,
      "1996": 1576,
      "1997": 1624,
      "1998": 1650,
      "1999": 1677,
      "2000": 1722,
      "2001": 1787,
      "2002": 1807,
      "2003": 1854,
      "2004": 1890,
      "2005": 1946,
      "2006": 2023,
      "2007": 2065,
      "2008": 2154,
      "2009": 2155,
      "2010": 2211,
      "2011": 2247,
      "2012": 2313,
      "2013": 2350,
      "2014": 2387,
      "2015": 2385,
      "2016": 2418,
      "2017": 2478,
      "2018": 2529,
      "2019": 2568,
      "2020": 2632,
      "2021": 2669
    };
    const years = Object.keys(cpi).sort();
    const mostRecentYear = years[years.length - 1];
    //
    const fromYearElement = document.querySelector("[name='fromYear']");
    const toYearElement = document.querySelector("[name='toYear']");
    const fromAmountElement = document.querySelector("[name='fromAmount']");
    const toAmountElement = document.querySelector("[name='toAmount']");
    //
    for (const year of years) {
      const optionElement = document.createElement("option");
      optionElement.value = year;
      optionElement.textContent = mostRecentYear - year < 100 ? year.substring(2) : year;
      fromYearElement.append(optionElement);
      toYearElement.append(optionElement.cloneNode(true));
    }
    //
    const prefix = "inflation-us-annual.";
    function localStorageGetItem(keyName) {
      return localStorage.getItem(prefix + keyName);
    }
    function localStorageSetItem(keyName, keyValue) {
      localStorage.setItem(prefix + keyName, keyValue);
    }
    //
    let fromYear;
    let toYear;
    let fromAmount;
    let toAmount;
    let moreRecentlyHasEnteredToAmount;
    //
    function selectFromYear() {
      for (const option of fromYearElement.selectedOptions) option.selected = false;
      fromYearElement.querySelector(`option[value='${fromYear}']`).selected = true;
    }
    function selectToYear() {
      for (const option of toYearElement.selectedOptions) option.selected = false;
      toYearElement.querySelector(`option[value='${toYear}']`).selected = true;
    }
    //
    function yearBeforeToYear() {
      return years[years.indexOf(toYear) - 1 || 0];
    }
    function yearAfterFromYear() {
      return years[years.indexOf(fromYear) + 1 || years.length - 1];
    }
    //
    function setFromURLAndMemoryAndStorage() {
      // use what is given in the URL's hash, if anything,
      // reuse from memory if not first invocation,
      // else use from localStorage, if anything,
      // else use defaults
      let hash = document.location.hash; // if any
      if (hash !== undefined) {
        history.pushState("", document.title, document.location.pathname); // clear
        try {
          hash = Object.fromEntries(hash.replace(/^#/, "").split(",").map(entry => entry.split("=")));
          ({ fy: fromYear = fromYear, ty: toYear = toYear, fa: fromAmount = fromAmount, ta: toAmount = toAmount } = hash);
          if (toAmount && !fromAmount) moreRecentlyHasEnteredToAmount = true;
        } finally {
          hash = undefined;
        }
      }
      //
      toYear = toYear ?? (localStorageGetItem("toYear") || years[years.length - 1]);
      if (!cpi[toYear]) toYear = mostRecentYear; // if not known
      selectToYear(toYear);
      //
      fromYear = fromYear ?? localStorageGetItem("fromYear");
      if (!cpi[fromYear]) fromYear = yearBeforeToYear(); // if not known
      selectFromYear(fromYear);
      //
      fromAmount = fromAmount ?? (Number(localStorageGetItem("fromAmount")) || 0);
      toAmount = toAmount ?? (Number(localStorageGetItem("toAmount")) || 0);
      moreRecentlyHasEnteredToAmount = moreRecentlyHasEnteredToAmount ?? (localStorageGetItem("moreRecentlyHasEnteredToAmount") || false);
      //
      fromToOrToFrom();
    }
    setFromURLAndMemoryAndStorage(); // first time
    //
    function showAmounts() {
      if (Math.abs(fromAmount) < 10) fromAmount = Math.round(fromAmount * 100) / 100;
      else if (fromAmount < 100) fromAmount = Math.round(fromAmount * 10) / 10;
      else fromAmount = Math.round(fromAmount);
      if (Math.abs(toAmount) < 10) toAmount = Math.round(toAmount * 100) / 100;
      else if (toAmount < 100) toAmount = Math.round(toAmount * 10) / 10;
      else toAmount = Math.round(toAmount);
      fromAmountElement.value = fromAmount;
      toAmountElement.value = toAmount;
      localStorageSetAll();
    }
    function fromTo() {
      toAmount = fromAmount * cpi[toYear] / cpi[fromYear];
      showAmounts();
    }
    function toFrom() {
      fromAmount = toAmount * cpi[fromYear] / cpi[toYear];
      showAmounts();
    }
    function fromToOrToFrom() {
      if (!moreRecentlyHasEnteredToAmount) {
        fromTo();
      } else {
        toFrom();
      }
    }
    //
    fromYearElement.addEventListener("input", event => {
      fromYear = fromYearElement.selectedOptions[0].value;
      if (fromYear > toYear) { // >=
        fromYear = toYear; // yearBeforeToYear();
        selectFromYear(fromYear);
        fromYearElement.blur();
      }
      fromToOrToFrom();
    });
    toYearElement.addEventListener("input", event => {
      toYear = toYearElement.selectedOptions[0].value;
      if (toYear < fromYear) { // <=
        toYear = fromYear; // yearAfterFromYear();
        selectToYear(toYear);
        toYearElement.blur();
      }
      fromTo();
    });
    //
    function localStorageSetAll() {
      localStorageSetItem("fromYear", fromYear);
      localStorageSetItem("toYear", toYear);
      localStorageSetItem("fromAmount", fromAmount);
      localStorageSetItem("toAmount", toAmount);
      localStorageSetItem("moreRecentlyHasEnteredToAmount", moreRecentlyHasEnteredToAmount);
    }
    //
    fromAmountElement.addEventListener("input", event => {
      fromAmount = Number(fromAmountElement.value);
      moreRecentlyHasEnteredToAmount = false;
      fromTo();
    });
    toAmountElement.addEventListener("input", event => {
      toAmount = Number(toAmountElement.value);
      moreRecentlyHasEnteredToAmount = true;
      toFrom();
    });
    //
    fromAmountElement.addEventListener("click", event => {
      moreRecentlyHasEnteredToAmount = false;
    });
    toAmountElement.addEventListener("click", event => {
      moreRecentlyHasEnteredToAmount = true;
    });
    //
    window.addEventListener("hashchange", setFromURLAndMemoryAndStorage);
    //
    function copyURL() {
      const hash = `#fy=${fromYear},ty=${toYear},${moreRecentlyHasEnteredToAmount ? `ta=${toAmount}` : `fa=${fromAmount}`}`;
      navigator.clipboard.writeText(document.location.origin + document.location.pathname + hash);
    }
  </script>
</body>

</html>